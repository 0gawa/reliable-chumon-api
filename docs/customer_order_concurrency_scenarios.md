# é¡§å®¢å´ã‚ªãƒ¼ãƒ€ãƒ¼ã®ç«¶åˆã‚·ãƒŠãƒªã‚ªè§£èª¬

## å®Ÿè£…ã—ãŸãƒ­ãƒƒã‚¯æ©Ÿæ§‹ãŒå¯¾å¿œã™ã‚‹é¡§å®¢å´ã®ç«¶åˆã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®é‡è¤‡æ³¨æ–‡ ðŸ”„
**å¯¾å¿œæ©Ÿæ§‹: å†ªç­‰æ€§ã‚­ãƒ¼**

#### çŠ¶æ³
```
åˆ¸å£²æ©ŸAï¼ˆåŒä¸€ç«¯æœ«ã‹ã‚‰ã®é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼Ã—2ã€ã‚’é¸æŠž
â”œâ”€ æ±ºæ¸ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
â”œâ”€ ã‚µãƒ¼ãƒãƒ¼ã«æ³¨æ–‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
â”œâ”€ ã‚µãƒ¼ãƒãƒ¼å´ã§æ³¨æ–‡ä½œæˆå®Œäº† âœ…
â”œâ”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡ä¸­...
â””â”€ âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰

åˆ¸å£²æ©Ÿã®ç”»é¢
â””â”€ ã€Œã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
â””â”€ åŒã˜æ³¨æ–‡ãŒ2å›žé€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ âš ï¸
```

#### å†ªç­‰æ€§ã‚­ãƒ¼ãªã—ã®å ´åˆ
```
1å›žç›®: æ³¨æ–‡#123 ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆ2200å††ï¼‰
2å›žç›®: æ³¨æ–‡#124 ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆ2200å††ï¼‰
è«‹æ±‚é¡: 4400å†† âŒ äºŒé‡èª²é‡‘ï¼
```

#### å†ªç­‰æ€§ã‚­ãƒ¼ã‚ã‚Šã®å ´åˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```
1å›žç›®: æ³¨æ–‡#123 ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆ2200å††ï¼‰ - 201 Created
       idempotency_key: "550e8400-e29b-41d4-a716-446655440000"
       
2å›žç›®: æ—¢å­˜ã®æ³¨æ–‡#123 ã‚’è¿”ã™ï¼ˆ2200å††ï¼‰ - 200 OK
       ã€Œã“ã®æ³¨æ–‡ã¯æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€
       
è«‹æ±‚é¡: 2200å†† âœ… æ­£å¸¸ï¼
```

---

### ã‚·ãƒŠãƒªã‚ª2: åœ¨åº«åˆ‡ã‚Œå¯¸å‰ã®å•†å“ã¸ã®åŒæ™‚æ³¨æ–‡ ðŸ“¦
**å¯¾å¿œæ©Ÿæ§‹: æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ï¼ˆå°†æ¥ã®åœ¨åº«ç®¡ç†ã«å‚™ãˆãŸè¨­è¨ˆï¼‰**

#### çŠ¶æ³ï¼ˆå°†æ¥å®Ÿè£…äºˆå®šã®åœ¨åº«ç®¡ç†ã‚’æƒ³å®šï¼‰
```
æ®‹ã‚Šåœ¨åº«: 1å€‹ã®ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼

[åˆ¸å£²æ©ŸA]              [åˆ¸å£²æ©ŸB]
    â†“                      â†“
ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼æ³¨æ–‡        ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼æ³¨æ–‡
ï¼ˆã»ã¼åŒæ™‚ï¼‰            ï¼ˆã»ã¼åŒæ™‚ï¼‰
```

#### æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ãªã—ã®å ´åˆ
```
[åˆ¸å£²æ©ŸA]                     [åˆ¸å£²æ©ŸB]
åœ¨åº«ç¢ºèª: 1å€‹ âœ…              åœ¨åº«ç¢ºèª: 1å€‹ âœ…
åœ¨åº«æ¸›ç®—: 1â†’0                åœ¨åº«æ¸›ç®—: 1â†’0
æ³¨æ–‡æˆåŠŸ                      æ³¨æ–‡æˆåŠŸ

çµæžœ: 2ã¤ã®æ³¨æ–‡ãŒæˆåŠŸã—ãŸãŒã€å®Ÿéš›ã®åœ¨åº«ã¯1å€‹ âŒ
```

#### æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ã‚ã‚Šã®å ´åˆï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```
[åˆ¸å£²æ©ŸA]                     [åˆ¸å£²æ©ŸB]
BEGIN                        BEGIN
SELECT FOR UPDATE            SELECT FOR UPDATE
(ãƒ­ãƒƒã‚¯å–å¾—)                  (å¾…æ©Ÿä¸­...)
â†“
åœ¨åº«ç¢ºèª: 1å€‹ âœ…
åœ¨åº«æ¸›ç®—: 1â†’0
æ³¨æ–‡æˆåŠŸ
COMMIT                       
                             (ãƒ­ãƒƒã‚¯å–å¾—)
                             â†“
                             åœ¨åº«ç¢ºèª: 0å€‹ âŒ
                             ã‚¨ãƒ©ãƒ¼: åœ¨åº«åˆ‡ã‚Œ
                             ROLLBACK

çµæžœ: 1ã¤ã®æ³¨æ–‡ã®ã¿æˆåŠŸ âœ…
```

---

### ã‚·ãƒŠãƒªã‚ª3: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¾¡æ ¼å¤‰æ›´ä¸­ã®æ³¨æ–‡ ðŸ’°
**å¯¾å¿œæ©Ÿæ§‹: æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ + ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ**

#### çŠ¶æ³
```
[ç®¡ç†è€…]                    [é¡§å®¢ï¼ˆåˆ¸å£²æ©Ÿï¼‰]
ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã§              ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚’
ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã®              ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
ä¾¡æ ¼å¤‰æ›´ä¸­                  (1000å††ã¨è¡¨ç¤º)
1000å†† â†’ 1200å††            
    â†“                           â†“
ä¾¡æ ¼æ›´æ–°å®Ÿè¡Œä¸­...            æ³¨æ–‡ç¢ºå®šãƒœã‚¿ãƒ³æŠ¼ä¸‹
```

#### å¯¾ç­–1: æ‚²è¦³çš„ãƒ­ãƒƒã‚¯
```
[é¡§å®¢ã®æ³¨æ–‡ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³]
BEGIN
SELECT * FROM menus WHERE id = 1 FOR UPDATE
  â†“
ç®¡ç†è€…ã®ä¾¡æ ¼æ›´æ–°ã¯å¾…æ©ŸçŠ¶æ…‹ã«
  â†“
æ³¨æ–‡ä½œæˆï¼ˆ1000å††ã§ç¢ºå®šï¼‰
  â†“
COMMIT
  â†“
ç®¡ç†è€…ã®ä¾¡æ ¼æ›´æ–°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆ1200å††ã«ï¼‰
```

#### å¯¾ç­–2: ä¾¡æ ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
```sql
-- order_items ãƒ†ãƒ¼ãƒ–ãƒ«
{
  "menu_snapshot": {
    "id": 1,
    "name": "ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼",
    "price": 1000,  â† æ³¨æ–‡æ™‚ç‚¹ã®ä¾¡æ ¼ã‚’ä¿å­˜
    "category": "ãƒ¡ã‚¤ãƒ³"
  }
}
```

**çµæžœ**: é¡§å®¢ã¯è¡¨ç¤ºã•ã‚ŒãŸ1000å††ã§è³¼å…¥ã§ãã€å¾Œã‹ã‚‰ä¾¡æ ¼ãŒå¤‰ã‚ã£ã¦ã‚‚å½±éŸ¿ã‚’å—ã‘ãªã„ âœ…

---

### ã‚·ãƒŠãƒªã‚ª4: ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ï¼ˆè¤‡é›‘ãªåŒæ™‚æ³¨æ–‡ï¼‰ ðŸ”„
**å¯¾å¿œæ©Ÿæ§‹: ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡ºã¨ãƒªãƒˆãƒ©ã‚¤**

#### çŠ¶æ³
```
[åˆ¸å£²æ©ŸA]                        [åˆ¸å£²æ©ŸB]
ãƒ¡ãƒ‹ãƒ¥ãƒ¼A, B ã‚’æ³¨æ–‡              ãƒ¡ãƒ‹ãƒ¥ãƒ¼B, A ã‚’æ³¨æ–‡
    â†“                                â†“
BEGIN                             BEGIN
SELECT * FROM menus              SELECT * FROM menus 
WHERE id = A FOR UPDATE          WHERE id = B FOR UPDATE
(ãƒ¡ãƒ‹ãƒ¥ãƒ¼Aã‚’ãƒ­ãƒƒã‚¯)                (ãƒ¡ãƒ‹ãƒ¥ãƒ¼Bã‚’ãƒ­ãƒƒã‚¯)
    â†“                                â†“
SELECT * FROM menus              SELECT * FROM menus
WHERE id = B FOR UPDATE          WHERE id = A FOR UPDATE
(ãƒ¡ãƒ‹ãƒ¥ãƒ¼Bã‚’å¾…ã¤...)              (ãƒ¡ãƒ‹ãƒ¥ãƒ¼Aã‚’å¾…ã¤...)
    â†“                                â†“
  â¸ï¸ ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ç™ºç”Ÿ â¸ï¸
```

#### PostgreSQLã®è‡ªå‹•æ¤œå‡º
```
PostgreSQL: ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡º
  â†“
ç‰‡æ–¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
  â†“
ActiveRecord::Deadlocked ä¾‹å¤–ã‚’ç™ºç”Ÿ
```

#### å®Ÿè£…ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```ruby
rescue ActiveRecord::Deadlocked => e
  @errors << 'Transaction deadlock detected. Please retry your request.'
  nil
end
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
HTTP/1.1 409 Conflict
{
  "errors": ["Transaction deadlock detected. Please retry your request."]
}
```

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼ˆåˆ¸å£²æ©Ÿï¼‰**:
- è‡ªå‹•çš„ã«å†è©¦è¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œå‡¦ç†ä¸­ã§ã™...ã€ã¨è¡¨ç¤º

---

## å®Ÿéš›ã®é‹ç”¨ã‚·ãƒ¼ãƒ³

### ðŸ” ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰åº—ã®æ˜¼æ™‚
```
12:00 - ãƒ”ãƒ¼ã‚¯æ™‚
â”œâ”€ åˆ¸å£²æ©Ÿ 5å°ãŒåŒæ™‚ç¨¼åƒ
â”œâ”€ å¹³å‡ 30ç§’ã« 1æ³¨æ–‡
â””â”€ åŒæ™‚ã« 10ä»¶ ã®æ³¨æ–‡å‡¦ç†

ç«¶åˆã®å¯èƒ½æ€§:
âœ… åŒã˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã®åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ â†’ æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ã§é †æ¬¡å‡¦ç†
âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®š â†’ å†ªç­‰æ€§ã‚­ãƒ¼ã§é‡è¤‡é˜²æ­¢
âœ… äººæ°—å•†å“ã®åœ¨åº«åˆ‡ã‚Œé–“éš› â†’ ãƒ­ãƒƒã‚¯ã§ç¢ºå®Ÿã«åˆ¶å¾¡
```

### ðŸœ ãƒ©ãƒ¼ãƒ¡ãƒ³åº—ã®åˆ¸å£²æ©Ÿ
```
é™å®š20é£Ÿã®ãƒ©ãƒ¼ãƒ¡ãƒ³

æ®‹ã‚Š3é£Ÿã®æ™‚ç‚¹ã§:
â”œâ”€ å®¢A: æ³¨æ–‡ãƒœã‚¿ãƒ³æŠ¼ä¸‹
â”œâ”€ å®¢B: æ³¨æ–‡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼ˆ0.5ç§’å¾Œï¼‰
â”œâ”€ å®¢C: æ³¨æ–‡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼ˆ0.8ç§’å¾Œï¼‰
â””â”€ å®¢D: æ³¨æ–‡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼ˆ1.0ç§’å¾Œï¼‰

çµæžœ:
âœ… A, B, C: æ³¨æ–‡æˆåŠŸï¼ˆé †æ¬¡ãƒ­ãƒƒã‚¯å–å¾—ï¼‰
âŒ D: ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å®Œå£²ã—ã¾ã—ãŸã€
```

---

## ã¾ã¨ã‚

é¡§å®¢å´ã®ä¸»ãªç«¶åˆã‚·ãƒŠãƒªã‚ª:

1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼** â†’ å†ªç­‰æ€§ã‚­ãƒ¼ã§è§£æ±º âœ…
2. **åœ¨åº«åˆ‡ã‚Œç«¶åˆ** â†’ æ‚²è¦³çš„ãƒ­ãƒƒã‚¯ã§æº–å‚™å®Œäº† âœ…
3. **ä¾¡æ ¼å¤‰æ›´ä¸­ã®æ³¨æ–‡** â†’ ãƒ­ãƒƒã‚¯ + ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§å¯¾ç­–æ¸ˆã¿ âœ…
4. **ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯** â†’ è‡ªå‹•æ¤œå‡º + ãƒªãƒˆãƒ©ã‚¤ã§å¯¾å¿œ âœ…

ã™ã¹ã¦å®Ÿè£…æ¸ˆã¿ã§ã€å®Ÿé‹ç”¨ã«è€ãˆã‚‰ã‚Œã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ï¼
